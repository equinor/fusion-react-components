import { Meta, Markdown, ArgTypes, Canvas } from '@storybook/addon-docs/blocks';

import pkg from '#packages/ag-grid-person-cell/package.json';

import changelogReact from '#packages/ag-grid-person-cell/CHANGELOG.md?raw';

import { ChangeLog, PackageInfo } from '../../../components';

import * as stories from './ag-grid-person-cell.stories';

<Meta title="ag-grid/Person Cell/Docs" />

<PackageInfo pkg={pkg} />

<ArgTypes of={ stories.basic } />

## AgGrid Person Cell

This component is used to render a person's details within an AgGrid cell. The cell displays a [Person Cell](./?path=/docs/person-cell--docs) component, and when hovered, a tooltip provides additional information about the person in the form of [Person Card](./?path=/docs/person-card--docs) component.

<Canvas of={ stories.basic } meta={stories} />

### How to use

When you have prepared the data that will populate your AgGrid, use the `agGridPersonCell` function to define a column that will render the component.
To correctly map your data, pass in the relevant properties, such as `azureId`, `upn`, or `dataSource`. Additionally, you can change the cell's display by passing in optional props like `heading`, `subHeading`, `size`, and `showAvatar` to customize the appearance and content of the cell.

#### Code example

```tsx
const columnDefs = useMemo<ColDef[]>(() => {
  return [
    ...agGridColumns,
    agGridPersonCell({
      ...agCellData,
      field: 'fieldName', // The field name that holds person data
      azureId: (data: string) => data, // Function to extract Azure ID from data
      heading: (person) => person.name, // Function to extract person's name as heading
      subHeading: (person) => person.mail, // Function to extract person's email as sub heading
      size: 'small', // Specifies the size of the component
      showAvatar: true, // Determines whether to show the avatar in the cell
      dataToSort: (data) => data // Data to use for sorting
    })
  ];
}, []);
```

#### Customizing heading and subHeading with HTML

You can customize the content of the `heading` and `subHeading` in the component by passing functions that return HTML strings. This allows you to format the text or include additional elements like links.

For example, you might want to display the **job title** in bold and the **email** as a **clickable link**.

```tsx
    agGridPersonCell({
      ...agPersonCellData,
      heading: (person) => `<b>${person.jobTitle}</b>`,  // Custom HTML for heading
      subHeading: (person) => `<a href="mailto:${person.mail}">${person.mail}</a>`, // Custom HTML for subHeading
    })
```

<Canvas of={ stories.customHeadings } meta={stories} />

#### Using azureId/upn/dataSource through a custom object

You can configure the `azureId`, `upn` or `dataSource` property in the **agGridPersonCell** to extract values from nested objects within your data. This allows you to easily map data from complex structures.

For instance, if your data contains a nested object with the user's **upn**, you can access it and pass it to the **upn** prop.

```tsx
// Driver type used in example
type Driver = {
  driverNumber: number;
  personInfo: {
    upn: string;
  };
};

// Sample row data
const rowsData = [...Array(5)].map((_, index) => ({
  ...rowsData,
  // Nested object example
  driver: {
    driverNumber: '23'
    personInfo: {
      upn: `userUpn@example.com`,
    }
  }
}));

const columnDefs = useMemo(() => [
  ...agGridColumns,
  agGridPersonCell({
    ...agPersonCellData,
    field: 'driver',
    upn: (data: Driver) => data.personInfo.upn, // Access UPN from nested object
    heading: (person) => person.name,
    subHeading: (person) => person.jobTitle
  })
], []);
```

<Canvas of={ stories.customDataObject } meta={stories} />

#### Handling Array Data

The **agGridPersonCell** component automatically detects when the field contains an array of person identifiers and adapts its behavior accordingly:

- **AgGrid tooltips are disabled** for array fields. They are added as popover from EDS components for each element(person) added in a cell.
- **Heading and subHeading functions are not applied** to array data, because there is no usage of heading/subheading when rendering multiple person cards in a single cell.
- **Special CSS class** `personnel-table-cell` is applied for array fields vs `person-table-cell` for single person fields
- **showAvatar** is automatically set to ***true*** for array fields, displaying images for each person in the array. If set to ***false***, only the first letter of the persons name will be shown.

```tsx
// Example with mixed data types
const rowsData = [...Array(5)].map((_, index) => ({
  number: index,
  manufacturer: faker.vehicle.manufacturer(),
  model: faker.vehicle.model(),
  driver: faker.string.uuid(), // Single person ID
  team: Array.from({ length: 5 }, () => faker.string.uuid()), // Array of person IDs
}));

const columnDefs = [
  // Single person column
  agGridPersonCell({
    field: 'driver',
    azureId: (data: string) => data,
    heading: (person) => person.name, // Applied for single person
    subHeading: (person) => person.mail, // Applied for single person
  }),
  
  // Array of persons column
  agGridPersonCell({
    field: 'team',
    azureId: (data: string) => data,
    showAvatar: true,
    // heading and subHeading are automatically ignored for arrays
  }),
];
```

<Canvas of={ stories.arrayData } meta={stories} />

**Key behaviors for array data:**

- ✅ **Automatic detection**: No configuration needed - arrays are detected automatically from field data
- ✅ **Multiple tooltips**: Each person in the array gets its own tooltip (EDS Popover)
- ✅ **Optimized rendering**: Cell renderer handles multiple persons efficiently
- ✅ **Mixed columns**: You can have both single person and array person columns in the same grid

#### Advanced Array Configuration

For more complex array handling, you can customize how person data is extracted from each element, like in custom object configuration written above.

#### Pittfall: Handling onRowClicked event

When the ``onRowClicked`` is defined in the `AgGridReact` component, you need to be aware of the following pitfall:

When the PersonCard is clicked, the `onRowClicked` event will also be triggered.

You can check for this inside the `onRowClicked` event handler by checking the `event.target` property.

```tsx
onRowClicked={(data: RowClickedEvent) => {
  if ((data.event?.target as Element)?.nodeName.toLowerCase() === 'fwc-person-card') {
    console.log('Clicking on personCard, do not continue with normal row click behavior');
    return;
  }
}}
```

## Changelog

<ChangeLog
  changelogs={{
    react: changelogReact,
  }}
/>
